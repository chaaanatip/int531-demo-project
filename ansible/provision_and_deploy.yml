สร้าง playbook ที่เป็นนามสกุล
เช่น provision_and_deploy.yml
---
###############################################
# PLAY 1 — Provision VM on Proxmox (cloud-init)
###############################################
- name: Provision VM on Proxmox and deploy app
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # ===== Proxmox API =====
    proxmox_api_host: 10.13.104.216
    proxmox_api_user: root@pam
    proxmox_api_password: int53106
    proxmox_node: int531-06

    # ===== Template & VM config =====
    vm_template: 'ubuntu-2404-cloudinit'
    vm_name: 'bjg-demo-vm'
    vm_hostname: 'bjg-demo-vm'

    vm_ip: 10.13.104.150
    vm_cidr: 24
    vm_gw: 10.13.104.254

    # ===== SSH ฝั่ง Ansible (WSL) =====
    ansible_ssh_key_path: '/home/niraphan2560/.ssh/id_ed25519'

    # ===== App config =====
    app_dir: /opt/myapp
    app_repo: 'https://github.com/chaaanatip/int531-demo-project.git'

  tasks:
    - name: Create VM from cloud-init template
      community.proxmox.proxmox_kvm:
        api_user: '{{ proxmox_api_user }}'
        api_password: '{{ proxmox_api_password }}'
        api_host: '{{ proxmox_api_host }}'
        node: '{{ proxmox_node }}'
        clone: '{{ vm_template }}'
        name: '{{ vm_name }}'
        full: true
        timeout: 300
        ipconfig:
          ipconfig0: 'ip={{ vm_ip }}/{{ vm_cidr }},gw={{ vm_gw }}'
      register: created_vm

    - name: Start new VM
      community.proxmox.proxmox_kvm:
        api_user: '{{ proxmox_api_user }}'
        api_password: '{{ proxmox_api_password }}'
        api_host: '{{ proxmox_api_host }}'
        node: '{{ proxmox_node }}'
        vmid: '{{ created_vm.vmid }}'
        state: started

    - name: Wait for SSH on VM
      ansible.builtin.wait_for:
        host: '{{ vm_ip }}'
        port: 22
        delay: 15
        timeout: 300

    - name: Register new VM as dynamic host
      ansible.builtin.add_host:
        name: new_vm
        ansible_host: '{{ vm_ip }}'
        ansible_user: 'dev'
        ansible_ssh_private_key_file: '{{ ansible_ssh_key_path }}'
        ansible_python_interpreter: /usr/bin/python3
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
        groups: provisioned

    - name: Show created VMID
      ansible.builtin.debug:
        msg: 'Created VM with VMID {{ created_vm.vmid }} on {{ proxmox_node }}'

###########################################################
# PLAY 2 — Configure VM & run app via make
###########################################################
- name: Configure new VM and run app via make
  hosts: new_vm
  become: yes
  gather_facts: yes

  vars:
    vm_hostname: 'bjg-demo-vm'
    app_dir: /opt/myapp
    app_repo: 'https://github.com/chaaanatip/int531-demo-project.git'

  tasks:
    - name: Wait for cloud-init to complete
      ansible.builtin.command: cloud-init status --wait
      changed_when: false
      failed_when: false

    - name: Wait for apt lock to be released
      ansible.builtin.shell: |
        while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 ; do
          echo "Waiting for apt lock..."
          sleep 5
        done
      changed_when: false

    - name: Set hostname inside VM
      ansible.builtin.hostname:
        name: '{{ vm_hostname }}'

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 600

    - name: Install base tools (git, make, curl, gnupg, ca-certificates)
      ansible.builtin.apt:
        name:
          - git
          - make
          - ca-certificates
          - curl
          - gnupg
        state: present

    - name: Ensure keyrings directory exists for Docker
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add Docker GPG key
      ansible.builtin.shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: Get system architecture for Docker repo
      ansible.builtin.command: dpkg --print-architecture
      register: system_arch
      changed_when: false

    - name: Add Docker APT repository
      ansible.builtin.apt_repository:
        repo: 'deb [arch={{ system_arch.stdout }} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable'
        state: present
        filename: docker
        update_cache: yes

    - name: Install Docker engine and compose plugin
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: Ensure Docker daemon is enabled and running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    - name: Add dev user to docker group
      ansible.builtin.user:
        name: '{{ ansible_user }}'
        groups: docker
        append: yes

    - name: Ensure app directory exists
      ansible.builtin.file:
        path: '{{ app_dir }}'
        state: directory
        owner: '{{ ansible_user }}'
        group: '{{ ansible_user }}'
        mode: '0755'

    - name: Clone app repo (default branch)
      ansible.builtin.git:
        repo: '{{ app_repo }}'
        dest: '{{ app_dir }}'
        update: yes
        force: yes
        version: HEAD
      become: yes
      become_user: '{{ ansible_user }}'

    - name: Run app with make run (as dev with docker group)
      ansible.builtin.shell: |
        sg docker -c "make run"
      args:
        chdir: '{{ app_dir }}'
      become: yes
      become_user: '{{ ansible_user }}'
